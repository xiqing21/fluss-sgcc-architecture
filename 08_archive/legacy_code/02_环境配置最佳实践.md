# 🛠️ 环境配置最佳实践

**文档版本**: v1.0  
**更新时间**: 2025年7月14日  
**适用环境**: Fluss 0.7.0 + Flink 1.20 + Docker Compose  

本文档提供SGCC Fluss架构环境配置的最佳实践指南。

---

## 📋 Docker Compose 配置

### JAR包挂载配置
```yaml
# ✅ 正确的JAR包挂载
taskmanager-sgcc-1:
  volumes:
    - ./fluss/jars:/opt/flink/lib/jars:ro

jobmanager-sgcc:
  volumes:
    - ./fluss/jars:/opt/flink/lib/jars:ro

# ❌ 错误：覆盖核心lib目录
taskmanager-sgcc-1:
  volumes:
    - ./fluss/jars:/opt/flink/lib  # 会覆盖Flink核心JAR
```

### 健康检查配置
```yaml
postgres-sgcc-source:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U sgcc_user -d sgcc_source"]
    interval: 10s
    timeout: 5s
    retries: 5

postgres-sgcc-sink:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U sgcc_user -d sgcc_target"]
    interval: 10s
    timeout: 5s
    retries: 5
```

### 资源限制配置
```yaml
taskmanager-sgcc-1:
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 4G
      reservations:
        cpus: '1.0'
        memory: 2G
  environment:
    - taskmanager.numberOfTaskSlots=8
    - taskmanager.memory.process.size=4096m
```

---

## 🔧 必需的JAR包清单

### Flink 1.20 兼容JAR包
```bash
# JDBC连接器 (440KB)
flink-connector-jdbc-3.3.0-1.20.jar

# PostgreSQL驱动 (1.1MB)
postgresql-42.7.7.jar

# PostgreSQL CDC连接器 (需要验证版本)
flink-sql-connector-postgres-cdc-3.1.1.jar
```

### 下载命令
```bash
# 创建JAR目录
mkdir -p fluss/jars

# 下载Flink 1.20兼容的JDBC连接器
wget https://repo1.maven.org/maven2/org/apache/flink/flink-connector-jdbc/3.3.0-1.20/flink-connector-jdbc-3.3.0-1.20.jar -O fluss/jars/flink-connector-jdbc-3.3.0-1.20.jar

# 下载最新PostgreSQL驱动
wget https://repo1.maven.org/maven2/org/postgresql/postgresql/42.7.7/postgresql-42.7.7.jar -O fluss/jars/postgresql-42.7.7.jar
```

---

## 🗄️ 数据库配置

### PostgreSQL CDC配置
```sql
-- 启用WAL日志
ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM SET max_wal_senders = 4;
ALTER SYSTEM SET max_replication_slots = 4;

-- 重启PostgreSQL使配置生效
SELECT pg_reload_conf();
```

### 创建复制槽
```sql
-- 创建逻辑复制槽
SELECT * FROM pg_create_logical_replication_slot('fluss_cdc_slot', 'pgoutput');

-- 验证复制槽状态
SELECT * FROM pg_replication_slots;
```

---

## 🚀 启动流程

### 标准启动顺序
```bash
# 1. 清理环境
docker-compose down
docker volume prune -f

# 2. 启动服务
docker-compose up -d

# 3. 等待服务就绪
sleep 45

# 4. 验证服务状态
docker ps --format "table {{.Names}}\t{{.Status}}"
```

### 健康检查脚本
```bash
#!/bin/bash
# 检查所有服务状态
services=("coordinator-server-sgcc" "tablet-server-sgcc" "jobmanager-sgcc" "taskmanager-sgcc-1" "postgres-sgcc-source" "postgres-sgcc-sink")

for service in "${services[@]}"; do
    if docker ps --format "table {{.Names}}" | grep -q "$service"; then
        echo "✅ $service 服务正常"
    else
        echo "❌ $service 服务异常"
    fi
done
```

---

## 🔍 故障排除

### 常见问题检查
```bash
# 1. 检查容器状态
docker ps -a

# 2. 查看容器日志
docker logs coordinator-server-sgcc --tail 50
docker logs tablet-server-sgcc --tail 50

# 3. 检查JAR包挂载
docker exec taskmanager-sgcc-1 ls -la /opt/flink/lib/jars/

# 4. 验证数据库连接
docker exec postgres-sgcc-source psql -U sgcc_user -d sgcc_source -c "SELECT 1;"
```

### 环境重建脚本
```bash
#!/bin/bash
# 完全重建环境
echo "停止所有服务..."
docker-compose down

echo "清理Docker资源..."
docker system prune -f
docker volume prune -f

echo "重新启动服务..."
docker-compose up -d

echo "等待服务就绪..."
sleep 60

echo "验证服务状态..."
docker ps --format "table {{.Names}}\t{{.Status}}"
```

---

## 📊 监控指标

### 系统资源监控
```bash
# 容器资源使用情况
docker stats --no-stream

# 磁盘使用情况
docker system df

# 网络连接状态
docker exec coordinator-server-sgcc netstat -tlnp
```

### Flink作业监控
```bash
# 查看运行中的作业
docker exec jobmanager-sgcc /opt/flink/bin/flink list

# 作业详细信息
docker exec jobmanager-sgcc /opt/flink/bin/flink info JOB_ID
```

---

## 🔒 安全最佳实践

### 密码管理
```yaml
# 使用环境变量管理密码
environment:
  - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-default_password}
  - FLINK_PASSWORD=${FLINK_PASSWORD:-default_password}
```

### 网络安全
```yaml
# 限制网络访问
networks:
  sgcc-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

---

## 📋 环境检查清单

### 启动前检查
- [ ] Docker和Docker Compose版本兼容
- [ ] 所有必需的JAR包已下载
- [ ] docker-compose.yml配置正确
- [ ] 端口未被占用
- [ ] 磁盘空间充足

### 运行中检查
- [ ] 所有容器运行正常
- [ ] 数据库连接正常
- [ ] Flink Web UI可访问
- [ ] 日志无错误信息

### 测试前检查
- [ ] 源数据库有测试数据
- [ ] CDC复制槽创建成功
- [ ] Flink任务槽充足
- [ ] 网络连接正常

---

**文档维护**: 根据环境配置实践持续更新  
**贡献者**: AI助手 & 用户协作  
**最后更新**: 2025年7月14日 