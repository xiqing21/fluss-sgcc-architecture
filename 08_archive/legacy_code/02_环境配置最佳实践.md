# ğŸ› ï¸ ç¯å¢ƒé…ç½®æœ€ä½³å®è·µ

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2025å¹´7æœˆ14æ—¥  
**é€‚ç”¨ç¯å¢ƒ**: Fluss 0.7.0 + Flink 1.20 + Docker Compose  

æœ¬æ–‡æ¡£æä¾›SGCC Flussæ¶æ„ç¯å¢ƒé…ç½®çš„æœ€ä½³å®è·µæŒ‡å—ã€‚

---

## ğŸ“‹ Docker Compose é…ç½®

### JARåŒ…æŒ‚è½½é…ç½®
```yaml
# âœ… æ­£ç¡®çš„JARåŒ…æŒ‚è½½
taskmanager-sgcc-1:
  volumes:
    - ./fluss/jars:/opt/flink/lib/jars:ro

jobmanager-sgcc:
  volumes:
    - ./fluss/jars:/opt/flink/lib/jars:ro

# âŒ é”™è¯¯ï¼šè¦†ç›–æ ¸å¿ƒlibç›®å½•
taskmanager-sgcc-1:
  volumes:
    - ./fluss/jars:/opt/flink/lib  # ä¼šè¦†ç›–Flinkæ ¸å¿ƒJAR
```

### å¥åº·æ£€æŸ¥é…ç½®
```yaml
postgres-sgcc-source:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U sgcc_user -d sgcc_source"]
    interval: 10s
    timeout: 5s
    retries: 5

postgres-sgcc-sink:
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U sgcc_user -d sgcc_target"]
    interval: 10s
    timeout: 5s
    retries: 5
```

### èµ„æºé™åˆ¶é…ç½®
```yaml
taskmanager-sgcc-1:
  deploy:
    resources:
      limits:
        cpus: '2.0'
        memory: 4G
      reservations:
        cpus: '1.0'
        memory: 2G
  environment:
    - taskmanager.numberOfTaskSlots=8
    - taskmanager.memory.process.size=4096m
```

---

## ğŸ”§ å¿…éœ€çš„JARåŒ…æ¸…å•

### Flink 1.20 å…¼å®¹JARåŒ…
```bash
# JDBCè¿æ¥å™¨ (440KB)
flink-connector-jdbc-3.3.0-1.20.jar

# PostgreSQLé©±åŠ¨ (1.1MB)
postgresql-42.7.7.jar

# PostgreSQL CDCè¿æ¥å™¨ (éœ€è¦éªŒè¯ç‰ˆæœ¬)
flink-sql-connector-postgres-cdc-3.1.1.jar
```

### ä¸‹è½½å‘½ä»¤
```bash
# åˆ›å»ºJARç›®å½•
mkdir -p fluss/jars

# ä¸‹è½½Flink 1.20å…¼å®¹çš„JDBCè¿æ¥å™¨
wget https://repo1.maven.org/maven2/org/apache/flink/flink-connector-jdbc/3.3.0-1.20/flink-connector-jdbc-3.3.0-1.20.jar -O fluss/jars/flink-connector-jdbc-3.3.0-1.20.jar

# ä¸‹è½½æœ€æ–°PostgreSQLé©±åŠ¨
wget https://repo1.maven.org/maven2/org/postgresql/postgresql/42.7.7/postgresql-42.7.7.jar -O fluss/jars/postgresql-42.7.7.jar
```

---

## ğŸ—„ï¸ æ•°æ®åº“é…ç½®

### PostgreSQL CDCé…ç½®
```sql
-- å¯ç”¨WALæ—¥å¿—
ALTER SYSTEM SET wal_level = logical;
ALTER SYSTEM SET max_wal_senders = 4;
ALTER SYSTEM SET max_replication_slots = 4;

-- é‡å¯PostgreSQLä½¿é…ç½®ç”Ÿæ•ˆ
SELECT pg_reload_conf();
```

### åˆ›å»ºå¤åˆ¶æ§½
```sql
-- åˆ›å»ºé€»è¾‘å¤åˆ¶æ§½
SELECT * FROM pg_create_logical_replication_slot('fluss_cdc_slot', 'pgoutput');

-- éªŒè¯å¤åˆ¶æ§½çŠ¶æ€
SELECT * FROM pg_replication_slots;
```

---

## ğŸš€ å¯åŠ¨æµç¨‹

### æ ‡å‡†å¯åŠ¨é¡ºåº
```bash
# 1. æ¸…ç†ç¯å¢ƒ
docker-compose down
docker volume prune -f

# 2. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 3. ç­‰å¾…æœåŠ¡å°±ç»ª
sleep 45

# 4. éªŒè¯æœåŠ¡çŠ¶æ€
docker ps --format "table {{.Names}}\t{{.Status}}"
```

### å¥åº·æ£€æŸ¥è„šæœ¬
```bash
#!/bin/bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
services=("coordinator-server-sgcc" "tablet-server-sgcc" "jobmanager-sgcc" "taskmanager-sgcc-1" "postgres-sgcc-source" "postgres-sgcc-sink")

for service in "${services[@]}"; do
    if docker ps --format "table {{.Names}}" | grep -q "$service"; then
        echo "âœ… $service æœåŠ¡æ­£å¸¸"
    else
        echo "âŒ $service æœåŠ¡å¼‚å¸¸"
    fi
done
```

---

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜æ£€æŸ¥
```bash
# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a

# 2. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs coordinator-server-sgcc --tail 50
docker logs tablet-server-sgcc --tail 50

# 3. æ£€æŸ¥JARåŒ…æŒ‚è½½
docker exec taskmanager-sgcc-1 ls -la /opt/flink/lib/jars/

# 4. éªŒè¯æ•°æ®åº“è¿æ¥
docker exec postgres-sgcc-source psql -U sgcc_user -d sgcc_source -c "SELECT 1;"
```

### ç¯å¢ƒé‡å»ºè„šæœ¬
```bash
#!/bin/bash
# å®Œå…¨é‡å»ºç¯å¢ƒ
echo "åœæ­¢æ‰€æœ‰æœåŠ¡..."
docker-compose down

echo "æ¸…ç†Dockerèµ„æº..."
docker system prune -f
docker volume prune -f

echo "é‡æ–°å¯åŠ¨æœåŠ¡..."
docker-compose up -d

echo "ç­‰å¾…æœåŠ¡å°±ç»ª..."
sleep 60

echo "éªŒè¯æœåŠ¡çŠ¶æ€..."
docker ps --format "table {{.Names}}\t{{.Status}}"
```

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### ç³»ç»Ÿèµ„æºç›‘æ§
```bash
# å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ
docker stats --no-stream

# ç£ç›˜ä½¿ç”¨æƒ…å†µ
docker system df

# ç½‘ç»œè¿æ¥çŠ¶æ€
docker exec coordinator-server-sgcc netstat -tlnp
```

### Flinkä½œä¸šç›‘æ§
```bash
# æŸ¥çœ‹è¿è¡Œä¸­çš„ä½œä¸š
docker exec jobmanager-sgcc /opt/flink/bin/flink list

# ä½œä¸šè¯¦ç»†ä¿¡æ¯
docker exec jobmanager-sgcc /opt/flink/bin/flink info JOB_ID
```

---

## ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ

### å¯†ç ç®¡ç†
```yaml
# ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†å¯†ç 
environment:
  - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-default_password}
  - FLINK_PASSWORD=${FLINK_PASSWORD:-default_password}
```

### ç½‘ç»œå®‰å…¨
```yaml
# é™åˆ¶ç½‘ç»œè®¿é—®
networks:
  sgcc-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

---

## ğŸ“‹ ç¯å¢ƒæ£€æŸ¥æ¸…å•

### å¯åŠ¨å‰æ£€æŸ¥
- [ ] Dockerå’ŒDocker Composeç‰ˆæœ¬å…¼å®¹
- [ ] æ‰€æœ‰å¿…éœ€çš„JARåŒ…å·²ä¸‹è½½
- [ ] docker-compose.ymlé…ç½®æ­£ç¡®
- [ ] ç«¯å£æœªè¢«å ç”¨
- [ ] ç£ç›˜ç©ºé—´å……è¶³

### è¿è¡Œä¸­æ£€æŸ¥
- [ ] æ‰€æœ‰å®¹å™¨è¿è¡Œæ­£å¸¸
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] Flink Web UIå¯è®¿é—®
- [ ] æ—¥å¿—æ— é”™è¯¯ä¿¡æ¯

### æµ‹è¯•å‰æ£€æŸ¥
- [ ] æºæ•°æ®åº“æœ‰æµ‹è¯•æ•°æ®
- [ ] CDCå¤åˆ¶æ§½åˆ›å»ºæˆåŠŸ
- [ ] Flinkä»»åŠ¡æ§½å……è¶³
- [ ] ç½‘ç»œè¿æ¥æ­£å¸¸

---

**æ–‡æ¡£ç»´æŠ¤**: æ ¹æ®ç¯å¢ƒé…ç½®å®è·µæŒç»­æ›´æ–°  
**è´¡çŒ®è€…**: AIåŠ©æ‰‹ & ç”¨æˆ·åä½œ  
**æœ€åæ›´æ–°**: 2025å¹´7æœˆ14æ—¥ 